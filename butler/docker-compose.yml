# Butler API
# Connects to: PostgreSQL (memory), voice-stack, smart-home-stack
# All services share the 'homeserver' network for seamless communication

services:
  butler-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: butler-api
    environment:
      # Database (same Immich PostgreSQL)
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@immich-postgres:5432/immich
      # Claude API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      # LiveKit (must match voice-stack config)
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      # Auth
      - JWT_SECRET=${JWT_SECRET}
      - INVITE_CODES=${INVITE_CODES:-BUTLER-001}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-}
      # Home Assistant
      - HOME_ASSISTANT_URL=http://homeassistant:8123
      - HOME_ASSISTANT_TOKEN=${HA_TOKEN:-}
      - HA_WEBHOOK_SECRET=${HA_WEBHOOK_SECRET:-}
      # Weather
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY:-}
      # Ollama (for local embeddings / semantic memory search)
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      # Radarr
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      # Sonarr
      - SONARR_URL=http://sonarr:8989
      - SONARR_API_KEY=${SONARR_API_KEY:-}
      # Jellyfin
      - JELLYFIN_URL=http://jellyfin:8096
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY:-}
      # Health & storage monitoring
      - EXTERNAL_DRIVE_PATH=${EXTERNAL_DRIVE_PATH:-/mnt/external}
      - STORAGE_THRESHOLDS=${STORAGE_THRESHOLDS:-70,80,90}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5}
      # Google OAuth (for Calendar, Gmail, etc.)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-http://localhost:3000/api/oauth/google/callback}
      - OAUTH_FRONTEND_URL=${OAUTH_FRONTEND_URL:-http://localhost:3000}
      # qBittorrent (download management)
      - QBITTORRENT_URL=${QBITTORRENT_URL:-http://qbittorrent:8081}
      - QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME:-admin}
      - QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD:-adminadmin}
      # Prowlarr
      - PROWLARR_URL=${PROWLARR_URL:-http://prowlarr:9696}
      - PROWLARR_API_KEY=${PROWLARR_API_KEY:-}
      # Seerr (media request management)
      - SEERR_URL=${SEERR_URL:-http://seerr:5055}
      - SEERR_API_KEY=${SEERR_API_KEY:-}
      # Immich (photo management + user provisioning)
      - IMMICH_URL=${IMMICH_URL:-http://immich-server:2283}
      - IMMICH_API_KEY=${IMMICH_API_KEY:-}
      # Audiobookshelf (user provisioning)
      - AUDIOBOOKSHELF_URL=${AUDIOBOOKSHELF_URL:-http://audiobookshelf:80}
      - AUDIOBOOKSHELF_ADMIN_TOKEN=${AUDIOBOOKSHELF_ADMIN_TOKEN:-}
      # Nextcloud (user provisioning)
      - NEXTCLOUD_URL=${NEXTCLOUD_URL:-http://nextcloud:80}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD:-}
      # WhatsApp Gateway (outbound notifications)
      - WHATSAPP_GATEWAY_URL=${WHATSAPP_GATEWAY_URL:-}
      # Features & limits
      - MAX_TOKENS=${MAX_TOKENS:-4096}
      - MAX_HISTORY_MESSAGES=${MAX_HISTORY_MESSAGES:-20}
      - WEB_SEARCH_ENABLED=${WEB_SEARCH_ENABLED:-true}
      - WEB_SEARCH_MAX_USES=${WEB_SEARCH_MAX_USES:-5}
      - MEDIA_FILES_ENABLED=${MEDIA_FILES_ENABLED:-true}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      # Web Push (VAPID keys for PWA push notifications)
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
      - VAPID_SUBJECT=${VAPID_SUBJECT:-mailto:admin@homeserver.local}
      # Host system info (accurate dashboard stats inside Docker)
      - HOST_PLATFORM=${HOST_PLATFORM:-}
      - HOST_ARCHITECTURE=${HOST_ARCHITECTURE:-}
      - HOST_MEMORY_TOTAL_GB=${HOST_MEMORY_TOTAL_GB:-0}
      - HAS_EXTERNAL_DRIVE=${HAS_EXTERNAL_DRIVE:-false}
    volumes:
      - ./api:/app/api:ro
      - ./tools:/app/tools:ro
      - ./migrations:/app/migrations:ro
      - ${DRIVE_PATH:-/Volumes/HomeServer}:/mnt/external
      - /private/var/empty:/mnt/host-ssd:ro
    ports:
      - "8000:8000"
    networks:
      - homeserver
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

networks:
  homeserver:
    external: true
