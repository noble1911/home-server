services:
  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: homeassistant
    environment:
      - TZ=Europe/London
    volumes:
      - homeassistant-config:/config
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8123:8123"
    networks:
      - homeserver
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/manifest.json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    command: tunnel --no-autoupdate --metrics localhost:2000 run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    networks:
      - homeserver
    restart: unless-stopped
    depends_on:
      homeassistant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2000/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

networks:
  homeserver:
    external: true

volumes:
  homeassistant-config:

# --- Butler Webhook Integration ---
# To enable event-driven automations from HA to Butler, add the following
# to your Home Assistant configuration.yaml (inside the HA config volume):
#
# rest_command:
#   butler_webhook:
#     url: "http://butler-api:8000/api/webhooks/homeassistant"
#     method: POST
#     headers:
#       X-Webhook-Secret: !secret butler_webhook_secret
#     content_type: application/json
#     payload: >-
#       {{ data | to_json }}
#
# Then use it in automations:
#
# automation:
#   - alias: "Notify Butler on motion"
#     trigger:
#       - platform: state
#         entity_id: binary_sensor.front_door_motion
#         to: "on"
#     action:
#       - service: rest_command.butler_webhook
#         data:
#           event_type: state_changed
#           entity_id: "{{ trigger.entity_id }}"
#           old_state: "{{ trigger.from_state.state }}"
#           new_state: "{{ trigger.to_state.state }}"
#           attributes:
#             friendly_name: "{{ trigger.to_state.attributes.friendly_name }}"
#             notify: true
#             message: "Motion detected at the front door"
#
# Add the secret to secrets.yaml:
#   butler_webhook_secret: "<same value as HA_WEBHOOK_SECRET env var>"
