services:
  livekit:
    image: livekit/livekit-server:v1.9.11
    container_name: livekit
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    networks:
      - homeserver
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7880"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  whisper:
    image: onerahmet/openai-whisper-asr-webservice:v1.9.1
    container_name: whisper
    environment:
      - ASR_MODEL=small
      - ASR_ENGINE=openai_whisper
    ports:
      - "9000:9000"
    networks:
      - homeserver
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  kokoro-tts:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:v0.2.4
    container_name: kokoro-tts
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - kokoro-models:/app/models
    ports:
      - "8880:8880"
    networks:
      - homeserver
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  livekit-agent:
    build: ../../butler/livekit-agent
    container_name: livekit-agent
    environment:
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - KOKORO_URL=http://kokoro-tts:8880
      - BUTLER_API_URL=http://butler-api:8000
      - BUTLER_API_KEY=${INTERNAL_API_KEY:-}
    depends_on:
      livekit:
        condition: service_healthy
      kokoro-tts:
        condition: service_healthy
    networks:
      - homeserver
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  homeserver:
    external: true

volumes:
  kokoro-models:
    name: kokoro-models
