# Step 14: Automated Backups

Protect service databases and Docker configs with rolling local backups on the Mac's internal SSD.

## Automated

```bash
curl -fsSL https://raw.githubusercontent.com/noble1911/home-server/main/scripts/14-backup.sh | bash
```

## Manual

### 1. Create Backup Directories

```bash
mkdir -p ~/ServerBackups/{databases,configs,weekly/databases,weekly/configs}
```

### 2. Run a Backup

```bash
./scripts/backup.sh
```

### 3. Schedule Daily Backups

The setup script installs a launchd agent that runs at 3:00 AM daily. To install manually:

```bash
# Copy the plist (generated by 14-backup.sh)
launchctl load ~/Library/LaunchAgents/com.homeserver.backup.plist

# Check it's loaded
launchctl list | grep homeserver.backup
```

## What Gets Backed Up

| Data | Method | Frequency | Backed Up? |
|------|--------|-----------|------------|
| PostgreSQL (Immich + Nextcloud) | `pg_dumpall` | Daily | Yes |
| Jellyfin config + DB | Volume tarball | Daily | Yes |
| Radarr, Sonarr, Bazarr configs | Volume tarballs | Daily | Yes |
| Audiobookshelf, LazyLibrarian | Volume tarballs | Daily | Yes |
| Prowlarr, qBittorrent configs | Volume tarballs | Daily | Yes |
| Home Assistant config | Volume tarball | Daily | Yes |
| Nextcloud app data | Volume tarball | Daily | Yes |
| Media files (Movies, TV, Books) | *Not backed up* | — | No (re-downloadable) |
| Photos (Immich library) | *User manages* | — | No (use iCloud/Google) |
| Docker caches | *Not backed up* | — | No (re-downloadable) |

## Retention Policy

| Type | Kept For | When |
|------|----------|------|
| Daily backups | 7 days | Every run |
| Weekly backups | 4 weeks | Sunday backups promoted to `weekly/` |

## Backup Directory Structure

```
~/ServerBackups/
├── databases/
│   └── immich-db-2026-02-05.sql.gz
├── configs/
│   ├── jellyfin-config-2026-02-05.tar.gz
│   ├── radarr-config-2026-02-05.tar.gz
│   └── ... (13 volumes total)
├── weekly/
│   ├── databases/
│   └── configs/
└── backup.log
```

## Restoring from Backup

### List Available Backups

```bash
./scripts/restore.sh --list
```

### Restore a Single Service

```bash
# Restore Jellyfin config (stops container, restores, restarts)
./scripts/restore.sh --service jellyfin-config --date 2026-02-05

# Restore PostgreSQL (Immich + Nextcloud databases)
./scripts/restore.sh --service immich-db --date 2026-02-05
```

### Restore Everything

```bash
./scripts/restore.sh --all --date 2026-02-05
```

### Restore from Weekly Backup

```bash
./scripts/restore.sh --weekly --service jellyfin-config --date 2026-02-02
```

## Configuration

| Variable | Default | Description |
|----------|---------|-------------|
| `BACKUP_DIR` | `~/ServerBackups` | Where backups are stored |
| `STORAGE_WARN_MB` | `15360` (15GB) | Warning threshold for total backup size |

Override when running manually:

```bash
BACKUP_DIR=/custom/path STORAGE_WARN_MB=20480 ./scripts/backup.sh
```

## Managing the Schedule

```bash
# Stop automated backups
launchctl unload ~/Library/LaunchAgents/com.homeserver.backup.plist

# Restart automated backups
launchctl load ~/Library/LaunchAgents/com.homeserver.backup.plist

# Check status
launchctl list | grep homeserver.backup
```

## Storage Estimates

| Services Running | Approximate Daily Backup Size |
|-----------------|------------------------------|
| All services | ~2-5 GB |
| Media + Books only | ~500 MB |
| Just Immich + HA | ~1-2 GB |

With 7 daily + 4 weekly retention, expect ~10-15 GB total at steady state.

## Next Step

→ [Step 15: Configure Alexa Integration (haaska)](./15-alexa-haaska.md)
